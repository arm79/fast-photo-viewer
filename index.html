<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://ogp.me/ns/fb#">
<head>
<link href="css/bootstrap.css" rel="stylesheet">
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<style type="text/css">
#personInfo{
    position:absolute;
    top:0px;
    right:0px;
    padding-right:20px;

}
#username
{
    margin-left:10px;
}
/*
.mynavbar{
    width:100%;
    height: 40px;
    margin:0px;
	-moz-box-shadow:inset 0px 1px 0px 0px #bdb6b6;
	-webkit-box-shadow:inset 0px 1px 0px 0px #bdb6b6;
	box-shadow:inset 0px 1px 0px 0px #bdb6b6;
	background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, rgb(70, 67, 67)), color-stop(1, rgb(0, 0, 0)) );
	background:-moz-linear-gradient( center top, rgb(70, 67, 67) 5%, rgb(0, 0, 0) 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#665a59', endColorstr='#1a0808');
	background-color:#665a59;
	-moz-border-radius:6px;
	-webkit-border-radius:6px;
	border-radius:6px;
	border:1px solid #000000;
	display:inline-block;
	color:#ffffff;
	font-family:arial;
	font-size:15px;
	font-weight:bold;
	padding:6px 24px;
	text-decoration:none;
	text-shadow:1px 1px 0px #6b3733;
	overflow:visible;
	position:fixed;
	z-index:20000;
	left:-2px;
	top:0px;
}
*/
#closeButton{
    position:absolute;
    top:0px;
    right:0px;
}
.enterButton {
	-moz-box-shadow:inset 0px 1px 0px 0px #f29c93;
	-webkit-box-shadow:inset 0px 1px 0px 0px #f29c93;
	box-shadow:inset 0px 1px 0px 0px #f29c93;
	background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #fe1a00), color-stop(1, #ce0100) );
	background:-moz-linear-gradient( center top, #fe1a00 5%, #ce0100 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#fe1a00', endColorstr='#ce0100');
	background-color:#fe1a00;
	-moz-border-radius:6px;
	-webkit-border-radius:6px;
	border-radius:6px;
	border:1px solid #d83526;
	display:block;
	color:#ffffff;
	font-family:arial;
	font-size:22px;
	font-weight:bold;
	padding:23px 10px 0px 10px;
	text-decoration:none;
	text-shadow:1px 1px 0px #b23e35;
	width:420px;
	height:60px;
	margin:0px auto;
	text-align:center;
}.enterButton:hover {
	background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #ce0100), color-stop(1, #fe1a00) );
	background:-moz-linear-gradient( center top, #ce0100 5%, #fe1a00 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ce0100', endColorstr='#fe1a00');
	background-color:#ce0100;
}.enterButton:active {
	position:relative;
	top:1px;
}
/* This imageless css button was generated by CSSButtonGenerator.com */
</style>

<style>

#testCanvas{
    margin: 0px auto;
}
::-webkit-scrollbar {
    height: 12px;
    width: 12px;
    background: #333;
    opacity: 0.2;
}
::-webkit-scrollbar-thumb {
    background: #ccc;
    -webkit-border-radius: 1ex;
    -webkit-box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.75);
}
::-webkit-scrollbar-corner {
    background: #333;
}

body{
    background: #333;
    padding: 0px;
}
#cover
{
    width:100%;
    height:100%;
    position:absolute;
    z-index:1000;
}
#heartShape
{
    width: 600px;
    height: 300px;
    margin: 40px auto;
}
#container{
    width:100%;
    height:100%;
    overflow-x:scroll;
    overflow-y:auto;
}
#gallery{
    width:100%;
    height:100%;
    margin:40px 0px 0px 0px;
    /*
    -webkit-transition: -webkit-transform 2s;
    */
}
/*
.zoomin{
    -webkit-transform: scale(4);
}
.moving{
    -webkit-transform: perspective(1200) rotateY(3deg);
}
.static{
    -webkit-transform: perspective(1200) rotateY(0deg);
}
*/
#popup{
    display:none;
    position:absolute;
}
.gallery-row{
    width:100%;
    height:200px;
    margin:2px 0px;
    padding:0px;
}
.photo{ 
    margin:10px;
    -webkit-box-shadow:5px 5px 5px #111;
        box-shadow:5px 5px 5px #111;
}

</style>
<!--
<link rel="stylesheet" href="assets/demoStyles.css" />
<script type="text/javascript" src="js/easeljs-0.5.0.min.js"></script>
<script type="text/javascript" src="js/tweenjs-0.4.0.min.js"></script>
<script type="text/javascript" src="js/Ease.js"></script>
-->
</head>
<body onload="setupPage()">
<div id="fb-root"></div>

<script>
  // Additional JS functions here
    var isLogInWithFB = false;
    window.fbAsyncInit = function() {
        FB.init({
              appId      : '535255149848774', // App ID
              channelUrl : 'vuamitom.github.com/valentine-album/index.html', // Channel File
              status     : true, // check login status
              cookie     : true, // enable cookies to allow the server to access the session
              xfbml      : true  // parse XFBML
               });

         // Additional init code here
         if(true) return;
         FB.getLoginStatus(function(response) {
              if (response.status === 'connected') {
                  // connected
                  console.log("User connected");
                  initData();
              } else if (response.status === 'not_authorized'){
                  // not_authorized
                  console.log("User not authorized");
                  login();
              } else {
                  // not_logged_in
                  console.log("not logged in");
                  login();
              }
              });     
        };

        // Load the SDK Asynchronously
        (function(d){
             var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
             if (d.getElementById(id)) {return;}
             js = d.createElement('script'); js.id = id; js.async = true;
             js.src = "//connect.facebook.net/en_US/all.js";
             ref.parentNode.insertBefore(js, ref);
         }(document));


    function login() {
        FB.login(function(response) {
            if (response.authResponse) {
             // connected
             initData();
            } else {
            // cancelled
            }
        }, {scope: 'user_photos,friends_photos'});
    }

    function notify(message){

    }

    function testAPI() {
        console.log('Welcome!  Fetching your information.... ');
        FB.api('/me?fields=id,relationship_status,photos', function(response) {
            console.log(response);
            console.log('Good to see you, ' + response.name + '.');
        });
    }

    function setupPage(){
        String.prototype.trim=function(){return this.replace(/^\s+|\s+$/, '');};

        window.people = {friendonly:true, data:[], query:""};
        $('#searchbox').typeahead({source:function(query,process){
            query = query.trim();
            if(Math.abs(query.length - people.query.length) >=3){ 
                if(people.friendonly)
                    queryFriends(query, process);
                people.query = query;
            }
            return people.data  ;
        }});

    }

    window.galleryConfig = {
        MAX_IMG_WIDTH : 300,
        MAX_IMG_HEIGHT: 190,
        GALLERY_ROWS : 4,
        SCROLL_BUFFER : 10
    };

    function gotoAlbum(){
		//var cover = document.getElementById("cover");
		//cover.parentNode.removeChild(cover);
        //go to facebook
        FB.getLoginStatus(function(response) {
              if (response.status === 'connected') {
                  // connected
                  console.log("User connected");
                  initData();
              } else if (response.status === 'not_authorized'){
                  // not_authorized
                  console.log("User not authorized");
                  login();
              } else {
                  // not_logged_in
                  console.log("not logged in");
                  login();
              }
              });
    }

    function handleUserList(resp){
        people.detail = resp.data;
        people.data = [];
        for(var i =  0 ; i < resp.data.length ;i ++){
            people.data[i] = resp.data[i].name;
        }
    }

    function queryFriends(query, uiUpdate){
        FB.api('/fql',{q:'SELECT uid,name FROM user where uid IN (SELECT uid2 FROM friend WHERE uid1=me()) AND strpos(lower(name),lower(\'' + query + '\')) >=0 '}, function(resp){
            handleUserList(resp);
            console.log(uiUpdate);
        });
    }

    function queryAll(query){
        FB.api('/search',{q:query,type:'user'}, handleUserList);
    }

    function initData(){
        isLogInWithFB = true;
        var cover = document.getElementById("cover");
        cover.parentNode.removeChild(cover);
        //setup listeners
        window.gallery = {};
        gallery.ui = document.getElementById('gallery');
        /*
        gallery.state = {page:0, width: 0, heights: [0,0,0]};
        gallery.state.apis = [];
        gallery.state.isLoading = false;
        gallery.state.prevXOffset = 0;
        gallery.state.popupShown = false;
        */
        resetGallery();
        gallery.user = 'me';

        gallery.ui.addEventListener('webkitTransitionEnd', function(event){
            if(gallery.ui.className.indexOf("static") >= 0){
                gallery.ui.style.webkitTransform = "perspective(0) rotateY(0deg)";
            }
        });
        var container = document.getElementById('container');
        container.onscroll = function(scrollEvt){
            //if((window.pageXOffset + window.innerWidth)>= gallery.state.width){
            //if scrolling right, change perspective
            /*
            if(gallery.state.prevXOffset < container.scrollLeft && !gallery.state.popupShown){ 
                if(gallery.ui.className.indexOf("moving")<0){
                    gallery.ui.style.webkitTransform = "";
                    gallery.ui.className = " moving";
                }
                if(gallery.state.timer){
                    clearInterval(gallery.state.timer);
                }
                gallery.state.timer = setInterval(function(){
                //remove perspective 
                    if(gallery.ui.className.indexOf("moving") >= 0){
                        //gallery.ui.className = gallery.ui.className.replace("moving","");
                        gallery.ui.className = "static";
                    }
                },1500);
            }
            */
            gallery.state.prevXOffset = container.scrollLeft;
            if((container.scrollLeft + window.innerWidth + galleryConfig.SCROLL_BUFFER ) >= container.scrollWidth){
            //load additional photos
            
                if(gallery.state.paging && !gallery.state.isLoading){
                    /*
                    gallery.state.isLoading  = true;
                    FB.api(gallery.state.paging.next, function(resp){
                        console.log("next page " + resp);
                        gallery.state.isLoading = false;
                        gallery.state.paging = resp.paging;
                        createGallery(resp.data);
                    });
                    */
                    loadNextPage();
                }
            }
            
            /*
            $('#searchbox').typeahead({source: function(query, process){
                //search  
                process(friends);
            }});
            */
        };
        //begin fetching data 
        gallery.state.isLoading = true;
        loadPhotoForUser(gallery.user);
        /*
        FB.api('/me/photos', {limit:24}, function(response){
            //construct gallery
            console.log(response);
            gallery.state.isLoading = false;
            gallery.state.paging = response.paging;
            createGallery(response.data);
            if(gallery.state.page == 1)
                loadNextPage();
        });
        */

        loadUserInfo(gallery.user);
    }

    function loadPhotoForUser(user){
        FB.api('/' + user + '/photos', {limit:24}, function(response){
        //construct gallery
            console.log(response);
            gallery.state.isLoading = false;
            gallery.state.paging = response.paging;
            createGallery(response.data);
            if(gallery.state.page == 1)
               loadNextPage();
       });
    }

    function loadUserInfo(user){
        FB.api('/' + user , {fields: 'id, name, picture'}, function(response){
            console.log(response);
            var name = response.name;
            var picture = response.picture.data.url;
            var username = document.getElementById('username');
            username.innerText = name;
            var profilePic = document.getElementById('profilePic');
            profilePic.src = picture;
        });
    }

    function loadNextPage(){
        gallery.state.isLoading  = true;
        FB.api(gallery.state.paging.next, function(resp){
            console.log("next page " + resp);
            gallery.state.isLoading = false;
                                                                                            gallery.state.paging = resp.paging;
                                                                                            createGallery(resp.data);
                                                                                        });
    }

    function createGallery(photos){
        var rows = [], rowDimens = [];
    
        for(var i = 0 ; i < galleryConfig.GALLERY_ROWS; i ++){
            if(!gallery.rows){
                var rowDiv = document.createElement('div');
                rowDiv.className="gallery-row";
                gallery.ui.appendChild(rowDiv);
                rows[i] = rowDiv;
            }
            rowDimens[i] = {width:0, height:0};
        }

        if(gallery.rows)
            rows = gallery.rows;
        else
            gallery.rows = rows;


        for(var index = 0 ; index < photos.length; index++){
            var photo = photos[index];
            var img = document.createElement('img');                
            //var wrapper = document.createElement('div');
            (function(photo){
                img.onclick = function(){
                //show image
                    showPopUp(photo.source, photo.width, photo.height);
                    console.log(photo.id);
                    gallery.ui.className += "zoomin";
                }
            })(photo);
            var thumbnail;
            for(imgIndx in photo.images){
                thumbnail  = photo.images[imgIndx];
                if(thumbnail.width <= galleryConfig.MAX_IMG_WIDTH && thumbnail.height <= galleryConfig.MAX_IMG_HEIGHT){
                    break;
                }
            }

            img.style.width = thumbnail.width + "px";
            img.style.height = thumbnail.height + "px";
            img.className = "photo";
            img.src = thumbnail.source;

            //wrapper.className = "wrapper";
            //wrapper.appendChild(img);
            var  rowIdx = index%galleryConfig.GALLERY_ROWS; 
            rows[rowIdx].appendChild(img);            
            rowDimens[rowIdx].width += thumbnail.width + 20;
            rowDimens[rowIdx].height = (rowDimens[rowIdx].height > thumbnail.height)? rowDimens[rowIdx].height : thumbnail.height;

        }

        //adjust row and screen size
        var maxWidth = 0;
        for( var i = 0 ; i < galleryConfig.GALLERY_ROWS ; i ++){
            gallery.state.heights[i] = (rowDimens[i].height > gallery.state.heights[i])? rowDimens[i].height : gallery.state.heights[i]; 
            rows[i].style.height = gallery.state.heights[i];//rowDimens[i].height + "px";
            //rows[i].style.height = "170px";
            maxWidth = (maxWidth < rowDimens[i].width) ? rowDimens[i].width : maxWidth;
        }
       
        gallery.ui.style.width = (gallery.state.width + maxWidth) + "px";
        if(!gallery.state)
            gallery.state = {};
        gallery.state.width += maxWidth;
        gallery.state.page +=1 ;
       
    }

    function showPopUp(imgUrl, cvsW, cvsH){
        var popup = document.getElementById('popup');
        var img = popup.children[1];
        img.src = imgUrl;
        popup.style.width = cvsW + "px";
        popup.style.height = cvsH + "px";
        popup.style.left = (window.innerWidth - cvsW)/2 + "px";
        popup.style.top = (window.innerHeight - cvsH)/2 + "px";
        popup.style.display = 'block';
        gallery.state.popupShown = true;
    }

    function closePopup(){
        var popup = document.getElementById('popup');
        popup.style.display = 'none';
        gallery.state.popupShown = false;
    }
    
    function getMax(){
        var max = 0 ; 
        for (var i = 0 ; i < arguments.length; i ++){
            if(arguments[i] > max)
                max = arguments[i];
        }
        return max;
    }

    function searchEnter(event){
        console.log(event);
        event.preventDefault();
        var name = document.getElementById('searchbox');
        for(var i = 0 ; i < people.detail.length; i ++){
            if(people.detail[i].name === name){
                console.log(people.detail[i]);
                break;
            }
        }
        return false;
    }

    function viewPhotoClicked(){
        if(!isLogInWithFB){
            //alert -- must login
            notify("Oops! Hello Batman, first, you need to take off your mask. Sign in with Facebook to use!");
            return;
        }
        var name = document.getElementById('searchbox').value;
        console.log(name);
        var i= 0;
        for(i = 0 ; i < people.detail.length; i++){
            if(people.detail[i].name === name){
                console.log(people.detail[i]);
                gallery.user = people.detail[i].uid;
                resetGallery();
                loadPhotoForUser(gallery.user);
                return;
            }
        }

        //display message 
        //can not find user with name 
        notify("We can't find the person you 're looking for. :( ");
    }

    function resetGallery(){
        $('.gallery-row').html('');
        gallery.state = {page:0, width: 0, heights: [0,0,0]};
        gallery.state.apis = [];
        gallery.state.isLoading = false;
        gallery.state.prevXOffset = 0;
        gallery.state.popupShown = false;
    }

    
    

</script>

<div id="cover">
    <div id="heartShape">
    <div>
    <svg xmlns="http://www.w3.org/2000/svg" version="1.1">     
	   <rect x="120" y="40" width="80" height="80"
        style="fill:red;stroke:black;stroke-width:8;fill-opacity:0.2;
          stroke-opacity:0.9"/>
          	   <rect x="140" y="60" width="80" height="80"
        style="fill:red;stroke:black;stroke-width:8;fill-opacity:0.2;
          stroke-opacity:0.9"/>
          	   <rect x="160" y="80" width="80" height="80"
        style="fill:red;stroke:black;stroke-width:8;fill-opacity:0.2;
          stroke-opacity:0.9"/>
          	   <rect x="180" y="100" width="80" height="80"
        style="fill:red;stroke:black;stroke-width:8;fill-opacity:0.2;
          stroke-opacity:0.9"/>
    </svg>
    </div>
    <div>
    	Fast Browsing Facebook Photos
    </div>
    </div>
    <fb:login-button>
	<div class="enterButton" onclick="gotoAlbum()">
    View Photos	
	</div>
</div>
<div class="navbar" style="position:fixed; z-index:10000;left:0px; top:0px; width:100% " id="headerBar">
<div class="navbar-inner">
        <form class="navbar-search pull-left " method="get" action="#" onsubmit="searchEnter(event); return false;" >
            <input type="text" class="search-query" placeholder="Find people ..."
                data-items="10"
                data-provide="typeahead" id="searchbox" autocomplete="off"/>
                <input type="button" value="View Photos" onclick="viewPhotoClicked()"></input>
        </form>
        </div>
        <div id="personInfo">
            <img id="profilePic"></img>
            <span id="username"></span>
        </div>
</div>
<div id="container">
<div id="gallery">    
</div>
</div>
<div id="popup">
<div id="closeButton" onclick="closePopup()"><img src="Button-Close-icon.png" style="width:50px;height:50px"/></div>
<img />
</div>

</body>
</html>
